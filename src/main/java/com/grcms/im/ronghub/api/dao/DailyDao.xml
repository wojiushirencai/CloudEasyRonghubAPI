<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.grcms.im.ronghub.api.dao.impl.DailyDaoImpl">

    <!-- MODEL FIELD TYPE -->
    <resultMap type="com.grcms.im.ronghub.api.domain.Daily" id="attendenceType">
        <id property="id" column="ID"/>
        <result property="title" column="TITLE"/>
        <result property="updateTime" column="UPDATE_TIME"/>
        <result property="updateDate" column="UPDATE_DATE"/>
        <result property="content" column="CONTENT"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="firstname" column="FIRSTNAME"/>
        <result property="lastname" column="LASTNAME"/>
        <result property="departmentId" column="DEPARTMENT_ID"/>
        <result property="departmentName" column="DEPARTMENT_NAME"/>
    </resultMap>

    <!-- 表名 -->
    <sql id="table">EC_DAILY</sql>

    <!-- 字段列表 -->
    <sql id="fields">
		ID,
		TITLE,
		CONTENT,
		MEMBER_ID,
		UPDATE_TIME,
		UPDATE_DATE,
		DEPARTMENT_ID
	</sql>

    <!-- INSERT -->
    <insert id="insert" parameterType="com.grcms.im.ronghub.api.domain.Daily">
        INSERT INTO
        <include refid="table"/>
        (
        <include refid="fields"/>
        )
        VALUES (
        #{id},
        #{title},
        #{content},
        #{memberId},
        #{updateTime},
        #{updateDate},
        #{departmentId}
        )
    </insert>

    <!-- UDPDATE NODE -->
    <update id="update" parameterType="com.grcms.im.ronghub.api.domain.Daily">
        UPDATE
        <include refid="table"/>
        SET
        TITLE = #{title},
        CONTENT = #{content},
        UPDATE_TIME = #{updateTime},
        UPDATE_Date = #{updateDate},
        WHERE
        ID = #{id}
    </update>

    <sql id="joinQuery">
    SELECT
        d.ID,
		d.TITLE,
		d.CONTENT,
		d.MEMBER_ID,
		d.UPDATE_TIME,
		d.UPDATE_DATE,
		d.DEPARTMENT_ID,
        m.FIRSTNAME,
        m.LASTNAME,
		dp.DEPARTMENT_NAME
        FROM
        EC_DAILY d
        JOIN
        ec_members m
        JOIN
        ec_department dp
        ON
        d.MEMBER_ID = m.id AND d.DEPARTMENT_ID = dp.id
    </sql>

    <!-- GET BY ID -->
    <select id="getById" parameterType="String" resultMap="attendenceType">
        <include refid="joinQuery"/>
        WHERE
        d.ID = #{id}
    </select>

    <!-- GET BY USER ID -->
    <select id="getByMemberId" parameterType="String" resultMap="attendenceType">
        <include refid="joinQuery"/>
        WHERE
        d.MEMBER_ID = #{value}
    </select>

    <!-- count by uri -->
    <select id="getTotalRecord" resultType="Integer">
        SELECT
        count(d.id)
       FROM
        ec_daily d
        JOIN
        ec_members m
        ON
        d.MEMBER_ID = m.id
    </select>

    <!-- 查找所有 -->
    <select id="getAll" resultMap="attendenceType">
        <include refid="joinQuery"/>
        ORDER BY
        UPDATE_TIME DESC
    </select>

    <!-- GET BY PAGE -->
    <select id="getByPage" resultMap="attendenceType" parameterType="map">
        <include refid="joinQuery"/>
        ORDER BY
        UPDATE_TIME DESC
        LIMIT #{index},#{pagesize}
    </select>

    <sql id="condition">
        <where>
            <if test="condition != null and condition.memberId != null">
                d.MEMBER_ID = #{condition.memberId}
            </if>
            <if test="condition != null and condition.departmentId != null">
                AND d.DEPARTMENT_ID = #{condition.departmentId}
            </if>
            <if test="condition != null and condition.updateDate != null">
                AND d.UPDATE_DATE = #{condition.updateDate}
            </if>
            <if test="condition != null and condition.lastname != null">
                AND m.LASTNAME = #{condition.lastname}
            </if>
            <if test="condition != null and condition.firstname != null">
                AND m.firstname = #{condition.firstname}
            </if>
        </where>
    </sql>
    <!-- GET BY PAGE AND CONDITION-->
    <select id="getByPageAndCondition" resultMap="attendenceType" parameterType="map">
        <include refid="joinQuery"/>
        <include refid="condition"/>
        ORDER BY
        UPDATE_TIME DESC
        LIMIT #{index},#{pagesize}
    </select>

    <select id="getTotalRecordByCondition" resultType="Integer" parameterType="map">
        SELECT
        count(d.id)
        FROM
        ec_daily d
        JOIN
        ec_members m
        ON
        d.MEMBER_ID = m.id
        <include refid="condition"/>
    </select>

    <!-- 根据ID删除 -->
    <delete id="deleteById" parameterType="String">
        DELETE
        FROM
        <include refid="table"/>
        WHERE
        ID = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds" parameterType="String">
        DELETE
        FROM
        <include refid="table"/>
        WHERE
        ID
        IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>
