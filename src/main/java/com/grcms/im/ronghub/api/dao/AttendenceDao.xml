<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.grcms.im.ronghub.api.dao.impl.AttendenceDaoImpl">

    <!-- MODEL FIELD TYPE -->
    <resultMap type="com.grcms.im.ronghub.api.domain.Attendency" id="attendenceType">
        <id property="id" column="ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="firstname" column="FIRSTNAME"/>
        <result property="lastname" column="LASTNAME"/>
        <result property="location" column="LOCATION"/>
        <result property="remark" column="REMARK"/>
        <result property="updateDate" column="UPDATE_DATE"/>
        <result property="updateTime" column="UPDATE_TIME"/>
        <result property="latitude" column="LATITUDE"/>
        <result property="longtitude" column="LONGTITUDE"/>
    </resultMap>

    <!-- 表名 -->
    <sql id="table">EC_ATTENDENCE</sql>

    <!-- 字段列表 -->
    <sql id="fields">
		ID,
		MEMBER_ID,
		LOCATION,
		REMARK,
		UPDATE_DATE,
		UPDATE_TIME,
		LATITUDE,
		LONGTITUDE
	</sql>

    <!-- INSERT -->
    <insert id="insert" parameterType="com.grcms.im.ronghub.api.domain.Attendency">
        INSERT INTO
        <include refid="table"/>
        (
        <include refid="fields"/>
        )
        VALUES (
        #{id},
        #{memberId},
        #{location},
        #{remark},
        #{updateDate},
        #{updateTime},
        #{latitude},
        #{longtitude}
        )
    </insert>

    <!-- UDPDATE NODE -->
    <update id="update" parameterType="com.grcms.im.ronghub.api.domain.Attendency">
        UPDATE
        <include refid="table"/>
        SET
        MEMBER_ID = #{memberId},
        LOCATION = #{location},
        REMARK = #{remark},
        UPDATE_DATE = #{updateDate},
        UPDATE_TIME = #{updateTime},
        LATITUDE = #{latitude},
        LONGTITUDE = #{longtitude}
        WHERE
        ID = #{id}
    </update>

    <sql id="joinQuery">
SELECT
        a.ID,
        a.MEMBER_ID,
        a.LOCATION,
        a.REMARK,
        a.UPDATE_DATE,
        a.UPDATE_TIME,
        a.LATITUDE,
        a.LONGTITUDE,
        m.FIRSTNAME,
        m.LASTNAME
        FROM
        ec_attendence a
        JOIN
        ec_members m
        ON
        a.MEMBER_ID = m.id
    </sql>
    <!-- GET BY ID -->
    <select id="getById" parameterType="String" resultMap="attendenceType">
      <include refid="joinQuery"/>
        WHERE
        a.ID = #{id}
    </select>

    <!-- GET BY USER ID -->
    <select id="getByMemberId" parameterType="String" resultMap="attendenceType">
        <include refid="joinQuery"/>
        WHERE
        a.MEMBER_ID = #{value}
    </select>

    <!-- count by uri -->
    <select id="getTotalRecord" resultType="Integer">
        SELECT
        count(a.id)
       FROM
        ec_attendence a
        JOIN
        ec_members m
        ON
        a.MEMBER_ID = m.id
    </select>

    <!-- 查找所有 -->
    <select id="getAll" resultMap="attendenceType">
        <include refid="joinQuery"/>
        ORDER BY
        UPDATE_TIME DESC
    </select>

    <!-- GET BY PAGE -->
    <select id="getByPage" resultMap="attendenceType" parameterType="map">
        <include refid="joinQuery"/>
        ORDER BY
        UPDATE_TIME DESC
        LIMIT #{index},#{pagesize}
    </select>

    <sql id="conditons">
        <where>
            <if test="condition != null and condition.memberId != null">
                a.MEMBER_ID = #{condition.memberId}
            </if>
            <if test="condition != null and condition.updateDate != null">
                AND a.UPDATE_DATE = #{condition.updateDate}
            </if>
            <if test="condition != null and condition.updateTime != null">
                AND a.UPDATE_TIME > #{condition.updateTime}
            </if>
            <if test="condition != null and condition.lastname != null">
                AND m.LASTNAME = #{condition.lastname}
            </if>
            <if test="condition != null and condition.firstname != null">
                AND m.firstname = #{condition.firstname}
            </if>
            <if test="condition != null and condition.departmentId != null">
                AND m.department_id = #{condition.departmentId}
            </if>
        </where>
    </sql>

    <select id="getTotalRecordByCondition" resultType="Integer" parameterType="map">
        SELECT
        count(a.id)
        FROM
        ec_attendence a
        JOIN
        ec_members m
        ON
        a.MEMBER_ID = m.id
        <include refid="conditons"/>
    </select>

    <!-- GET BY PAGE AND CONDITION-->
    <select id="getByPageAndCondition" resultMap="attendenceType" parameterType="map">
        <include refid="joinQuery"/>
        <include refid="conditons"/>
        ORDER BY
        UPDATE_TIME DESC
        LIMIT #{index},#{pagesize}
    </select>

    <!-- 根据ID删除 -->
    <delete id="deleteById" parameterType="String">
        DELETE
        FROM
        <include refid="table"/>
        WHERE
        ID = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds" parameterType="String">
        DELETE
        FROM
        <include refid="table"/>
        WHERE
        ID
        IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>
