<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.grcms.im.ronghub.api.dao.impl.ContactsDaoImpl">

    <!-- MODEL FIELD TYPE -->
    <resultMap type="com.grcms.im.ronghub.api.domain.ContactsGroup" id="domainType">
        <id property="groupId" column="GROUP_ID"/>
        <result property="groupName" column="GROUP_NAME"/>
        <collection property="contacts" column="GROUP_ID" ofType="com.grcms.im.ronghub.api.domain.Contacts">
            <id property="userId" column="USER_ID"/>
            <result property="username" column="USERNAME"/>
            <result property="firstname" column="FIRSTNAME"/>
            <result property="lastname" column="LASTNAME"/>
            <result property="phoneNumber" column="PHONE_NUMBER"/>
            <result property="portraitUri" column="PORTRAIT_URI"/>
            <result property="createTime" column="CREATE_TIME"/>
            <result property="updateTime" column="UPDATE_TIME"/>
            <result property="deleteTime" column="DELETE_TIME"/>
        </collection>
    </resultMap>


    <!-- GET BY ID -->
    <select id="getMembersByAllDepartments" resultMap="domainType">
        SELECT
        d.id as group_id,
        d.department_name as group_name,
        m.id as user_id,
        m.login_id as username,
        m.firstname,
        m.lastname,
        m.phone_number,
        m.portrait_uri,
        m.register_time as create_time,
        m.update_time,
        m.delete_time
        FROM
            ec_department d
        JOIN
            ec_members m
        ON
            m.department_id = d.id
    </select>


    <resultMap id="contactType" type="com.grcms.im.ronghub.api.domain.Contacts">
        <id property="userId" column="USER_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="firstname" column="FIRSTNAME"/>
        <result property="lastname" column="LASTNAME"/>
        <result property="phoneNumber" column="PHONE_NUMBER"/>
        <result property="portraitUri" column="PORTRAIT_URI"/>
        <result property="remark" column="REMARK"/>
        <result property="groupId" column="GROUP_ID"/>
        <result property="createTime" column="CREATE_TIME"/>
        <result property="updateTime" column="UPDATE_TIME"/>
        <result property="deleteTime" column="DELETE_TIME"/>
    </resultMap>

    <!-- GET BY ID -->
    <select id="getAllContacts" resultMap="contactType">
        SELECT
        m.id as user_id,
        m.login_id as username,
        m.firstname,
        m.lastname,
        m.phone_number,
        m.portrait_uri,
        m.remark,
        m.department_id as group_id,
        m.register_time as create_time,
        m.update_time,
        m.delete_time
        FROM
        ec_members m
        ORDER BY
        m.register_time
    </select>

    <select id="getById" resultMap="contactType" parameterType="string">
    SELECT
    m.id as user_id,
    m.login_id as username,
    m.firstname,
    m.lastname,
    m.phone_number,
    m.portrait_uri,
    m.remark,
    m.department_id as group_id,
    m.register_time as create_time,
    m.update_time,
    m.delete_time
    FROM
    ec_members m
    WHERE
    m.id = #{value}
</select>

    <select id="getBySpecialTime" resultMap="contactType" parameterType="string">
        SELECT
        m.id as user_id,
        m.login_id as username,
        m.firstname,
        m.lastname,
        m.phone_number,
        m.portrait_uri,
        m.remark,
        m.department_id as group_id,
        m.register_time as create_time,
        m.update_time,
        m.delete_time
        FROM
        ec_members m
        WHERE
        m.delete_time > #{value}
        OR
        m.update_time > #{value}
        OR
        m.register_time > #{value}
    </select>

    <update id="updateContacts" parameterType="com.grcms.im.ronghub.api.domain.Contacts">
    UPDATE
    ec_members
    SET
    firstname = #{firstname},
    lastname = #{lastname},
    phone_number = #{phoneNumber},
    remark = #{remark},
    update_time = now()
    WHERE
    id = #{userId}

    </update>

    <update id="updatePortrait" parameterType="map">
        UPDATE
        ec_members
        SET
        portrait_uri = #{portraitUrl},
        update_time = now()
        WHERE
        id = #{userId}
    </update>
</mapper>
